{% extends "base.html" %}

{% block title %}Dashboard - PuppeTRON{% endblock %}

{% block content %}
<div class="status-bar">
    <div>
        <strong>StoryTRON Status:</strong>
        {% if status %}
            <span style="color: #00ff00;">ğŸŸ¢ ONLINE</span>
        {% else %}
            <span style="color: #ff0000;">ğŸ”´ OFFLINE</span>
        {% endif %}
    </div>
    <div>
        <strong>ÄŒas:</strong> {{ timestamp }}
    </div>
</div>

{% if status %}
<div class="card">
    <h2>ğŸ¤– AktivnÃ­ Agent</h2>
    <p><strong>ID:</strong> {{ status.active_agent }}</p>
    {% if agents and agents.agents %}
        {% for agent in agents.agents %}
            {% if agent.id == status.active_agent %}
                <p><strong>NÃ¡zev:</strong> {{ agent.name }}</p>
                <p><strong>Popis:</strong> {{ agent.description }}</p>
            {% endif %}
        {% endfor %}
    {% endif %}
</div>

<div class="card">
    <h2>ğŸ“Š SystÃ©movÃ© informace</h2>
    <p><strong>SluÅ¾ba:</strong> {{ status.service }}</p>
    <p><strong>Status:</strong> {{ status.status }}</p>
</div>

<div class="card">
    <h2>ğŸ® RychlÃ© akce</h2>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button class="btn" onclick="refreshStatus()">ğŸ”„ Obnovit status</button>
        <button class="btn" onclick="sendKeepAlive()">ğŸ’“ Keep-alive ping</button>
        <button class="btn btn-danger" onclick="sendEmergencyMessage()">ğŸš¨ NouzovÃ¡ zprÃ¡va</button>
    </div>
</div>

{% if agents and agents.agents %}
<div class="card">
    <h2>ğŸ”„ RychlÃ© pÅ™epnutÃ­ agenta</h2>
    <div class="agent-grid">
        {% for agent in agents.agents %}
        <div class="agent-card {% if agent.id == status.active_agent %}active{% endif %}">
            <h3>{{ agent.name }}</h3>
            <p>{{ agent.description }}</p>
            {% if agent.id != status.active_agent %}
                <form method="POST" action="{{ url_for('switch_agent') }}" style="margin-top: 10px;">
                    <input type="hidden" name="agent_id" value="{{ agent.id }}">
                    <button type="submit" class="btn">Aktivovat</button>
                </form>
            {% else %}
                <div style="margin-top: 10px;">
                    <span style="color: #00ff00;">âœ… AKTIVNÃ</span>
                </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="card">
    <h2>ğŸ“± Poslat zprÃ¡vu do Pomo zaÅ™Ã­zenÃ­</h2>
    <form onsubmit="sendMessageToPomo(event)">
        <div class="form-group">
            <input type="text" class="form-control" id="pomoMessage" placeholder="ZprÃ¡va pro pomo zaÅ™Ã­zenÃ­..." required>
        </div>
        <button type="submit" class="btn">ğŸ“¤ Poslat</button>
    </form>
    <div id="pomoResult" style="margin-top: 10px;"></div>
</div>

{% else %}
<div class="card error">
    <h2>âŒ StoryTRON nedostupnÃ½</h2>
    <p>Nelze se pÅ™ipojit k StoryTRON serveru. Zkontrolujte, zda bÄ›Å¾Ã­ na {{ STORYTRON_BASE_URL }}.</p>
    <button class="btn" onclick="location.reload()">ğŸ”„ Zkusit znovu</button>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function refreshStatus() {
    location.reload();
}

function sendKeepAlive() {
    fetch('/api/status')
        .then(response => response.json())
        .then(data => {
            alert('Keep-alive odpovÄ›Ä: ' + JSON.stringify(data, null, 2));
        })
        .catch(error => {
            alert('Chyba pÅ™i keep-alive: ' + error);
        });
}

function sendEmergencyMessage() {
    const message = prompt('Zadejte nouzovou zprÃ¡vu:');
    if (message) {
        sendMessageToPomo(null, message);
    }
}

function sendMessageToPomo(event, customMessage = null) {
    if (event) event.preventDefault();

    const message = customMessage || document.getElementById('pomoMessage').value;
    if (!message) return;

    fetch('/send-message', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        const result = document.getElementById('pomoResult');
        if (data.success) {
            result.innerHTML = '<div style="color: #00ff00;">âœ… ' + data.message + '</div>';
        } else {
            result.innerHTML = '<div style="color: #ff0000;">âŒ Chyba pÅ™i odesÃ­lÃ¡nÃ­ zprÃ¡vy</div>';
        }
        if (!customMessage) {
            document.getElementById('pomoMessage').value = '';
        }
    })
    .catch(error => {
        document.getElementById('pomoResult').innerHTML = '<div style="color: #ff0000;">âŒ Chyba: ' + error + '</div>';
    });
}

// Auto-refresh kaÅ¾dÃ½ch 30 sekund
setInterval(refreshStatus, 30000);
</script>
{% endblock %}
