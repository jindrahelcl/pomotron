{% extends "base.html" %}

{% block title %}Dashboard - StoryTRON{% endblock %}

{% block content %}
<div class="status-bar">
    <div>
        <strong>StoryTRON Status:</strong>
        {% if status %}
            <span style="color: #00ff00;">ğŸŸ¢ ONLINE</span>
        {% else %}
            <span style="color: #ff0000;">ğŸ”´ OFFLINE</span>
        {% endif %}
    </div>
    <div>
        <strong>ÄŒas:</strong> {{ timestamp }}
    </div>
</div>

{% if status %}
<div class="card">
    <h2>ğŸ¤– AktivnÃ­ Agent</h2>
    <p><strong>ID:</strong> {{ status.active_agent }}</p>
    {% if agents and agents.agents %}
        {% for agent in agents.agents %}
            {% if agent.id == status.active_agent %}
                <p><strong>NÃ¡zev:</strong> {{ agent.name }}</p>
            {% endif %}
        {% endfor %}
    {% endif %}
</div>

{% if agents and agents.agents %}
<div class="card">
    <h2>ğŸ”„ RychlÃ© pÅ™epnutÃ­ agenta</h2>
    <div class="agent-grid">
        {% for agent in agents.agents %}
        <div class="agent-card {% if agent.id == status.active_agent %}active{% endif %}">
            <h3>{{ agent.name }}</h3>
            {% if agent.id != status.active_agent %}
                <form method="POST" action="{{ url_for('web_switch_agent') }}" style="margin-top: 10px;">
                    <input type="hidden" name="agent_id" value="{{ agent.id }}">
                    <button type="submit" class="btn">Aktivovat</button>
                </form>
            {% else %}
                <div style="margin-top: 10px;">
                    <span style="color: #00ff00;">âœ… AKTIVNÃ</span>
                </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="card">
    <h2>ğŸ’¬ Chat s aktivnÃ­m agentem</h2>
    <form onsubmit="sendChatMessage(event)">
        <div class="form-group">
            <input type="text" class="form-control" id="chatMessage" placeholder="NapiÅ¡te zprÃ¡vu pro agenta..." required>
        </div>
        <button type="submit" class="btn">ğŸ“¤ Poslat zprÃ¡vu</button>
    </form>
    <div id="chatResult" style="margin-top: 10px;"></div>
</div>

<div class="card">
    <h2>ğŸ“œ PoslednÃ­ zprÃ¡vy (3)</h2>
    <div id="messageHistory">
        <p style="color: #888;">NaÄÃ­tÃ¡nÃ­ historie...</p>
    </div>
    <div style="margin-top: 10px;">
        <a href="{{ url_for('web_history') }}" class="btn">ğŸ“œ Zobrazit celou historii</a>
    </div>
</div>

<div class="card">
    <h2>ğŸ“± Poslat zprÃ¡vu do Pomo zaÅ™Ã­zenÃ­</h2>
    <form onsubmit="sendMessageToPomo(event)">
        <div class="form-group">
            <input type="text" class="form-control" id="pomoMessage" placeholder="ZprÃ¡va pro pomo zaÅ™Ã­zenÃ­..." required>
        </div>
        <button type="submit" class="btn">ğŸ“¤ Poslat</button>
    </form>
    <div id="pomoResult" style="margin-top: 10px;"></div>
</div>

{% else %}
<div class="card error">
    <h2>âŒ StoryTRON nedostupnÃ½</h2>
    <p>Nelze se pÅ™ipojit k StoryTRON serveru. Zkontrolujte, zda bÄ›Å¾Ã­ na {{ STORYTRON_BASE_URL }}.</p>
    <button class="btn" onclick="location.reload()">ğŸ”„ Zkusit znovu</button>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function sendChatMessage(event) {
    event.preventDefault();

    const message = document.getElementById('chatMessage').value;
    if (!message) return;

    fetch('/api/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        const result = document.getElementById('chatResult');
        if (data.agent_response) {
            result.innerHTML = '<div style="color: #00ff00;">âœ… ZprÃ¡va odeslÃ¡na</div>';
        } else {
            result.innerHTML = '<div style="color: #ff0000;">âŒ Chyba pÅ™i komunikaci s agentem</div>';
        }
        document.getElementById('chatMessage').value = '';
        loadHistory(); // Refresh history after sending message
    })
    .catch(error => {
        document.getElementById('chatResult').innerHTML = '<div style="color: #ff0000;">âŒ Chyba: ' + error + '</div>';
    });
}

function loadHistory() {
    fetch('/api/history')
    .then(response => response.json())
    .then(data => {
        const historyDiv = document.getElementById('messageHistory');
        if (data.history && data.history.length > 0) {
            const recent3 = data.history.slice(-3).reverse();
            historyDiv.innerHTML = recent3.map(msg => `
                <div style="border: 1px solid #333; margin: 5px 0; padding: 10px; border-radius: 5px;">
                    <div style="font-size: 0.8em; color: #888; margin-bottom: 5px;">
                        ${new Date(msg.timestamp).toLocaleString()} |
                        OdesÃ­latel: ${msg.sender === 'web' ? 'ğŸ‘¤ Web' : 'ğŸ® Pomo'} |
                        Agent: ${msg.agent}
                    </div>
                    <div style="margin: 5px 0;">
                        <strong>ğŸ“¤ ZprÃ¡va:</strong> ${msg.message}
                    </div>
                    <div style="margin: 5px 0;">
                        <strong>ğŸ“¥ OdpovÄ›Ä:</strong> ${msg.response}
                    </div>
                </div>
            `).join('');
        } else {
            historyDiv.innerHTML = '<p style="color: #888;">Å½Ã¡dnÃ© zprÃ¡vy v historii.</p>';
        }
    })
    .catch(error => {
        document.getElementById('messageHistory').innerHTML = '<div style="color: #ff0000;">âŒ Chyba pÅ™i naÄÃ­tÃ¡nÃ­ historie</div>';
    });
}

function sendMessageToPomo(event, customMessage = null) {
    if (event) event.preventDefault();

    const message = customMessage || document.getElementById('pomoMessage').value;
    if (!message) return;

    fetch('/send-message', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        const result = document.getElementById('pomoResult');
        if (data.success) {
            result.innerHTML = '<div style="color: #00ff00;">âœ… ' + data.message + '</div>';
        } else {
            result.innerHTML = '<div style="color: #ff0000;">âŒ Chyba pÅ™i odesÃ­lÃ¡nÃ­ zprÃ¡vy</div>';
        }
        if (!customMessage) {
            document.getElementById('pomoMessage').value = '';
        }
    })
    .catch(error => {
        document.getElementById('pomoResult').innerHTML = '<div style="color: #ff0000;">âŒ Chyba: ' + error + '</div>';
    });
}

// Load history when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadHistory();
});
</script>
{% endblock %}
