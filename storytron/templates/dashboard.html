{% extends "base.html" %}

{% block title %}Dashboard - StoryTRON{% endblock %}

{% block content %}
<div class="status-bar">
    <div>
        <strong>StoryTRON Status:</strong>
        {% if status %}
            <span style="color: #00ff00;">ğŸŸ¢ ONLINE</span>
        {% else %}
            <span style="color: #ff0000;">ğŸ”´ OFFLINE</span>
        {% endif %}
    </div>
    <div>
        <strong>ÄŒas:</strong> {{ timestamp }}
    </div>
</div>

{% if status %}
<div class="card">
    <h2>ğŸ¤– AktivnÃ­ Agent</h2>
    <p><strong>ID:</strong> {{ status.active_agent }}</p>
    {% if agents and agents.agents %}
        {% for agent in agents.agents %}
            {% if agent.id == status.active_agent %}
                <p><strong>NÃ¡zev:</strong> {{ agent.name }}</p>
            {% endif %}
        {% endfor %}
    {% endif %}
</div>

{% if agents and agents.agents %}
<div class="card">
    <h2>ğŸ”„ RychlÃ© pÅ™epnutÃ­ agenta</h2>
    <div class="agent-grid">
        {% for agent in agents.agents %}
        <div class="agent-card {% if agent.id == status.active_agent %}active{% endif %}">
            <h3>{{ agent.name }}</h3>
            {% if agent.id != status.active_agent %}
                <form method="POST" action="{{ url_for('web_switch_agent') }}" style="margin-top: 10px;">
                    <input type="hidden" name="agent_id" value="{{ agent.id }}">
                    <button type="submit" class="btn">Aktivovat</button>
                </form>
            {% else %}
                <div style="margin-top: 10px;">
                    <span style="color: #00ff00;">âœ… AKTIVNÃ</span>
                </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="card">
    <h2>ğŸ’¬ Chat s aktivnÃ­m agentem</h2>
    <form onsubmit="sendChatMessage(event)">
        <div class="form-group">
            <input type="text" class="form-control" id="chatMessage" placeholder="NapiÅ¡te zprÃ¡vu pro agenta..." required>
        </div>
        <button type="submit" class="btn">ğŸ“¤ Poslat zprÃ¡vu</button>
    </form>
    <div id="chatResult" style="margin-top: 10px;"></div>
</div>

<div class="card">
    <h2>ğŸ“± Poslat zprÃ¡vu do Pomo zaÅ™Ã­zenÃ­</h2>
    <form onsubmit="sendMessageToPomo(event)">
        <div class="form-group">
            <input type="text" class="form-control" id="pomoMessage" placeholder="ZprÃ¡va pro pomo zaÅ™Ã­zenÃ­..." required>
        </div>
        <button type="submit" class="btn">ğŸ“¤ Poslat</button>
    </form>
    <div id="pomoResult" style="margin-top: 10px;"></div>
</div>

{% else %}
<div class="card error">
    <h2>âŒ StoryTRON nedostupnÃ½</h2>
    <p>Nelze se pÅ™ipojit k StoryTRON serveru. Zkontrolujte, zda bÄ›Å¾Ã­ na {{ STORYTRON_BASE_URL }}.</p>
    <button class="btn" onclick="location.reload()">ğŸ”„ Zkusit znovu</button>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function sendChatMessage(event) {
    event.preventDefault();

    const message = document.getElementById('chatMessage').value;
    if (!message) return;

    fetch('/api/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        const result = document.getElementById('chatResult');
        if (data.agent_response) {
            result.innerHTML = `
                <div style="border-left: 3px solid #ffff00; padding: 10px; margin: 5px 0; background-color: rgba(255,255,0,0.1);">
                    <strong>ğŸ‘¤ Vy:</strong> ${message}
                </div>
                <div style="border-left: 3px solid #00ff00; padding: 10px; margin: 5px 0; background-color: rgba(0,255,0,0.1);">
                    <strong>ğŸ¤– ${data.active_agent}:</strong> ${data.agent_response}
                </div>
            `;
        } else {
            result.innerHTML = '<div style="color: #ff0000;">âŒ Chyba pÅ™i komunikaci s agentem</div>';
        }
        document.getElementById('chatMessage').value = '';
    })
    .catch(error => {
        document.getElementById('chatResult').innerHTML = '<div style="color: #ff0000;">âŒ Chyba: ' + error + '</div>';
    });
}

function sendMessageToPomo(event, customMessage = null) {
    if (event) event.preventDefault();

    const message = customMessage || document.getElementById('pomoMessage').value;
    if (!message) return;

    fetch('/send-message', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        const result = document.getElementById('pomoResult');
        if (data.success) {
            result.innerHTML = '<div style="color: #00ff00;">âœ… ' + data.message + '</div>';
        } else {
            result.innerHTML = '<div style="color: #ff0000;">âŒ Chyba pÅ™i odesÃ­lÃ¡nÃ­ zprÃ¡vy</div>';
        }
        if (!customMessage) {
            document.getElementById('pomoMessage').value = '';
        }
    })
    .catch(error => {
        document.getElementById('pomoResult').innerHTML = '<div style="color: #ff0000;">âŒ Chyba: ' + error + '</div>';
    });
}
</script>
{% endblock %}
