{% extends "base.html" %}

{% block title %}Dashboard - StoryTRON{% endblock %}

{% block content %}
<div class="status-bar">
    <div>
        <strong>StoryTRON Status:</strong>
        {% if status %}
            <span style="color: #00ff00;">🟢 ONLINE</span>
        {% else %}
            <span style="color: #ff0000;">🔴 OFFLINE</span>
        {% endif %}
    </div>
    <div>
        <strong>Čas:</strong> {{ timestamp }}
    </div>
</div>

{% if status %}
<div class="card">
    <h2>🤖 Aktivní Agent</h2>
    <p><strong>ID:</strong> {{ status.active_agent }}</p>
    {% if agents and agents.agents %}
        {% for agent in agents.agents %}
            {% if agent.id == status.active_agent %}
                <p><strong>Název:</strong> {{ agent.name }}</p>
            {% endif %}
        {% endfor %}
    {% endif %}
</div>

{% if agents and agents.agents %}
<div class="card">
    <h2>🔄 Rychlé přepnutí agenta</h2>
    <div class="agent-grid">
        {% for agent in agents.agents %}
        <div class="agent-card {% if agent.id == status.active_agent %}active{% endif %}">
            <h3>{{ agent.name }}</h3>
            {% if agent.id != status.active_agent %}
                <form method="POST" action="{{ url_for('web_switch_agent') }}" style="margin-top: 10px;">
                    <input type="hidden" name="agent_id" value="{{ agent.id }}">
                    <button type="submit" class="btn">Aktivovat</button>
                </form>
            {% else %}
                <div style="margin-top: 10px;">
                    <span style="color: #00ff00;">✅ AKTIVNÍ</span>
                </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="card">
    <h2>💬 Chat s aktivním agentem</h2>
    <form onsubmit="sendChatMessage(event)">
        <div class="form-group">
            <input type="text" class="form-control" id="chatMessage" placeholder="Napište zprávu pro agenta..." required>
        </div>
        <button type="submit" class="btn">📤 Poslat zprávu</button>
    </form>
    <div id="chatResult" style="margin-top: 10px;"></div>
</div>

<div class="card">
    <h2>📜 Poslední zprávy (3)</h2>
    <div id="messageHistory">
        <p style="color: #888;">Načítání historie...</p>
    </div>
    <div style="margin-top: 10px;">
        <a href="{{ url_for('web_history') }}" class="btn">📜 Zobrazit celou historii</a>
    </div>
</div>

<div class="card">
    <h2>📱 Poslat zprávu do Pomo zařízení</h2>
    <form onsubmit="sendMessageToPomo(event)">
        <div class="form-group">
            <input type="text" class="form-control" id="pomoMessage" placeholder="Zpráva pro pomo zařízení..." required>
        </div>
        <button type="submit" class="btn">📤 Poslat</button>
    </form>
    <div id="pomoResult" style="margin-top: 10px;"></div>
</div>

{% else %}
<div class="card error">
    <h2>❌ StoryTRON nedostupný</h2>
    <p>Nelze se připojit k StoryTRON serveru. Zkontrolujte, zda běží na {{ STORYTRON_BASE_URL }}.</p>
    <button class="btn" onclick="location.reload()">🔄 Zkusit znovu</button>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function sendChatMessage(event) {
    event.preventDefault();

    const message = document.getElementById('chatMessage').value;
    if (!message) return;

    fetch('/api/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        const result = document.getElementById('chatResult');
        if (data.agent_response) {
            result.innerHTML = '<div style="color: #00ff00;">✅ Zpráva odeslána</div>';
        } else {
            result.innerHTML = '<div style="color: #ff0000;">❌ Chyba při komunikaci s agentem</div>';
        }
        document.getElementById('chatMessage').value = '';
        loadHistory(); // Refresh history after sending message
    })
    .catch(error => {
        document.getElementById('chatResult').innerHTML = '<div style="color: #ff0000;">❌ Chyba: ' + error + '</div>';
    });
}

function loadHistory() {
    fetch('/api/history')
    .then(response => response.json())
    .then(data => {
        const historyDiv = document.getElementById('messageHistory');
        if (data.history && data.history.length > 0) {
            const recent3 = data.history.slice(-3).reverse();
            historyDiv.innerHTML = recent3.map(msg => `
                <div style="border: 1px solid #333; margin: 5px 0; padding: 10px; border-radius: 5px;">
                    <div style="font-size: 0.8em; color: #888; margin-bottom: 5px;">
                        ${new Date(msg.timestamp).toLocaleString()} |
                        Odesílatel: ${msg.sender === 'web' ? '👤 Web' : '🎮 Pomo'} |
                        Agent: ${msg.agent}
                    </div>
                    <div style="margin: 5px 0;">
                        <strong>📤 Zpráva:</strong> ${msg.message}
                    </div>
                    <div style="margin: 5px 0;">
                        <strong>📥 Odpověď:</strong> ${msg.response}
                    </div>
                </div>
            `).join('');
        } else {
            historyDiv.innerHTML = '<p style="color: #888;">Žádné zprávy v historii.</p>';
        }
    })
    .catch(error => {
        document.getElementById('messageHistory').innerHTML = '<div style="color: #ff0000;">❌ Chyba při načítání historie</div>';
    });
}

function sendMessageToPomo(event, customMessage = null) {
    if (event) event.preventDefault();

    const message = customMessage || document.getElementById('pomoMessage').value;
    if (!message) return;

    fetch('/send-message', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        const result = document.getElementById('pomoResult');
        if (data.success) {
            result.innerHTML = '<div style="color: #00ff00;">✅ ' + data.message + '</div>';
        } else {
            result.innerHTML = '<div style="color: #ff0000;">❌ Chyba při odesílání zprávy</div>';
        }
        if (!customMessage) {
            document.getElementById('pomoMessage').value = '';
        }
    })
    .catch(error => {
        document.getElementById('pomoResult').innerHTML = '<div style="color: #ff0000;">❌ Chyba: ' + error + '</div>';
    });
}

// Load history when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadHistory();
});
</script>
{% endblock %}
