{% extends "base.html" %}

{% block title %}Historie zpráv - StoryTRON{% endblock %}

{% block content %}
<div class="card">
    <h2>📜 Kompletní historie zpráv</h2>
    <p>Všechny zprávy a odpovědi mezi uživateli a agenty.</p>
</div>

<div class="card">
    <div id="fullMessageHistory" style="max-height: 600px; overflow-y: auto;">
        <p style="color: #888;">Načítání historie...</p>
    </div>
    <div style="margin-top: 10px;">
        <button class="btn" onclick="loadFullHistory()">🔄 Obnovit historii</button>
        <button class="btn btn-danger" onclick="clearFullHistory()">🗑️ Vymazat historii</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function loadFullHistory() {
    fetch('{{ url_for("get_history") }}')
    .then(response => response.json())
    .then(data => {
        const historyDiv = document.getElementById('fullMessageHistory');
        if (data.history && data.history.length > 0) {
            historyDiv.innerHTML = data.history.slice().reverse().map(msg => `
                <div style="border: 1px solid #333; margin: 5px 0; padding: 10px; border-radius: 5px; position: relative;">
                    <button onclick="deleteMessage('${msg.timestamp}')"
                            style="position: absolute; top: 5px; right: 5px; background: #ff4444; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 14px; line-height: 1;"
                            title="Smazat tuto zprávu"
                            onmouseover="this.style.backgroundColor='#ff0000'"
                            onmouseout="this.style.backgroundColor='#ff4444'">×</button>
                    <div style="font-size: 0.8em; color: #888; margin-bottom: 5px; margin-right: 30px;">
                        ${new Date(msg.timestamp).toLocaleString()} |
                        Odesílatel: ${msg.sender === 'web' ? '👤 Web' : '🎮 Pomo'} |
                        Agent: ${msg.agent}
                    </div>
                    <div style="margin: 5px 0;">
                        <strong>📤 Zpráva:</strong> ${msg.message}
                    </div>
                    <div style="margin: 5px 0;">
                        <strong>📥 Odpověď:</strong> ${msg.response}
                    </div>
                </div>
            `).join('');
        } else {
            historyDiv.innerHTML = '<p style="color: #888;">Žádné zprávy v historii.</p>';
        }
    })
    .catch(error => {
        document.getElementById('fullMessageHistory').innerHTML = '<div style="color: #ff0000;">❌ Chyba při načítání historie</div>';
    });
}

function clearFullHistory() {
    if (confirm('Opravdu chcete vymazat celou historii zpráv?')) {
        fetch('{{ url_for("clear_history") }}', { method: 'DELETE' })
        .then(() => {
            loadFullHistory();
        })
        .catch(error => {
            alert('Chyba při mazání historie: ' + error);
        });
    }
}

function deleteMessage(timestamp) {
    if (confirm('Opravdu chcete smazat tuto zprávu?')) {
        fetch(`/api/history/${encodeURIComponent(timestamp)}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Chyba při mazání zprávy: ' + data.error);
            } else {
                loadFullHistory(); // Reload the history to reflect changes
            }
        })
        .catch(error => {
            alert('Chyba při mazání zprávy: ' + error);
        });
    }
}

// Load history when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadFullHistory();
});
</script>
{% endblock %}
