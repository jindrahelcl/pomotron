{% extends "base.html" %}

{% block title %}Historie zprÃ¡v - StoryTRON{% endblock %}

{% block content %}
<div class="card">
    <h2>ğŸ“œ KompletnÃ­ historie zprÃ¡v</h2>
    <p>VÅ¡echny zprÃ¡vy a odpovÄ›di mezi uÅ¾ivateli a agenty.</p>
</div>

<div class="card">
    <div id="fullMessageHistory" style="max-height: 600px; overflow-y: auto;">
        <p style="color: #888;">NaÄÃ­tÃ¡nÃ­ historie...</p>
    </div>
    <div style="margin-top: 10px;">
        <button class="btn" onclick="loadFullHistory()">ğŸ”„ Obnovit historii</button>
        <button class="btn btn-danger" onclick="clearFullHistory()">ğŸ—‘ï¸ Vymazat historii</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function loadFullHistory() {
    fetch('{{ url_for("get_history") }}')
    .then(response => response.json())
    .then(data => {
        const historyDiv = document.getElementById('fullMessageHistory');
        if (data.history && data.history.length > 0) {
            historyDiv.innerHTML = data.history.slice().reverse().map(msg => `
                <div style="border: 1px solid #333; margin: 5px 0; padding: 10px; border-radius: 5px;">
                    <div style="font-size: 0.8em; color: #888; margin-bottom: 5px;">
                        ${new Date(msg.timestamp).toLocaleString()} |
                        OdesÃ­latel: ${msg.sender === 'web' ? 'ğŸ‘¤ Web' : 'ğŸ® Pomo'} |
                        Agent: ${msg.agent}
                    </div>
                    <div style="margin: 5px 0;">
                        <strong>ğŸ“¤ ZprÃ¡va:</strong> ${msg.message}
                    </div>
                    <div style="margin: 5px 0;">
                        <strong>ğŸ“¥ OdpovÄ›Ä:</strong> ${msg.response}
                    </div>
                </div>
            `).join('');
        } else {
            historyDiv.innerHTML = '<p style="color: #888;">Å½Ã¡dnÃ© zprÃ¡vy v historii.</p>';
        }
    })
    .catch(error => {
        document.getElementById('fullMessageHistory').innerHTML = '<div style="color: #ff0000;">âŒ Chyba pÅ™i naÄÃ­tÃ¡nÃ­ historie</div>';
    });
}

function clearFullHistory() {
    if (confirm('Opravdu chcete vymazat celou historii zprÃ¡v?')) {
        fetch('{{ url_for("clear_history") }}', { method: 'DELETE' })
        .then(() => {
            loadFullHistory();
        })
        .catch(error => {
            alert('Chyba pÅ™i mazÃ¡nÃ­ historie: ' + error);
        });
    }
}

// Load history when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadFullHistory();
});

// Auto-refresh every 30 seconds
setInterval(loadFullHistory, 30000);
</script>
{% endblock %}
