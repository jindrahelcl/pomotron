{% extends "base.html" %}

{% block title %}Agent Prompts - StoryTRON{% endblock %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div style="max-width: 1000px; margin: 0 auto; padding: 20px;">
    <h2>Agent Prompts</h2>
    <p class="text-muted">Edit system prompts for your agents</p>

    <div style="margin-bottom: 20px;">
        <button class="btn" onclick="openAgentDialog()" style="width: 100%; padding: 15px; font-size: 16px;">
            <span id="selected-agent-text">Select Agent to Edit</span>
        </button>
    </div>

    <div id="editor-section" style="display: none;">
        <h4 id="current-agent" style="margin-bottom: 15px; color: #00ff00;">Agent: </h4>

        <div style="margin-bottom: 20px;">
            <label for="prompt-editor" style="display: block; margin-bottom: 5px; font-weight: bold;">System Prompt:</label>
            <textarea id="prompt-editor"
                      rows="20"
                      style="width: 100%; padding: 12px; font-family: monospace; font-size: 14px; background-color: #222; border: 1px solid #444; color: #00ff00; border-radius: 5px; resize: vertical; box-sizing: border-box;"
                      placeholder="Select an agent to edit its prompt..."></textarea>
        </div>

        <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
            <small style="color: #888;">
                Characters: <span id="char-count">0</span>
            </small>
            <small style="color: #888;">
                Lines: <span id="line-count">0</span>
            </small>
        </div>

        <div class="controls">
            <button class="btn" onclick="savePrompt()">ðŸ’¾ Save</button>
            <button class="btn btn-secondary" onclick="reloadPrompt()">ðŸ”„ Reload</button>
        </div>
    </div>

    <div id="no-selection" style="text-align: center; color: #888; margin-top: 50px;">
        <h4>Select an agent to edit its prompt</h4>
        <p>You can modify the system prompts that define how each agent behaves and responds.</p>
    </div>
</div>

<!-- Toast notification for save success -->
<div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 1050;">
    <div id="save-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-body d-flex align-items-center justify-content-center" style="background-color: #222; border: 1px solid #00ff00; color: #00ff00; border-radius: 5px; min-width: 250px;">
            <i class="bi bi-check-circle-fill me-2"></i>
            <span>Prompt saved successfully!</span>
        </div>
    </div>
</div>

<!-- Agent Selection Modal -->
<div id="agent-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 1000; padding: 20px; box-sizing: border-box;">
    <div style="background-color: #111; border: 2px solid #333; border-radius: 10px; max-width: 500px; margin: 50px auto; padding: 20px; max-height: 80vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; color: #00ff00;">Select Agent</h3>
            <button onclick="closeAgentDialog()" style="background: none; border: none; color: #00ff00; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px;">&times;</button>
        </div>

        <div id="agent-list" style="display: flex; flex-direction: column; gap: 10px;">
            {% for prompt in prompts %}
            <button class="agent-option"
                    data-agent-id="{{ prompt.agent_id }}"
                    onclick="selectAgent('{{ prompt.agent_id }}')"
                    style="background-color: #222; border: 1px solid #444; color: #00ff00; padding: 15px; border-radius: 5px; cursor: pointer; text-align: left; font-family: 'Courier New', monospace; font-size: 14px; transition: all 0.3s ease;">
                <div style="font-weight: bold; margin-bottom: 5px;">{{ prompt.agent_id }}</div>
                <div style="font-size: 12px; color: #888;">{{ prompt.content|length }} characters</div>
            </button>
            {% endfor %}
        </div>
    </div>
</div>

<script>
let currentAgentId = null;
let originalContent = '';

function openAgentDialog() {
    document.getElementById('agent-modal').style.display = 'block';
    document.body.style.overflow = 'hidden'; // Prevent scrolling behind modal
}

function closeAgentDialog() {
    document.getElementById('agent-modal').style.display = 'none';
    document.body.style.overflow = 'auto'; // Restore scrolling
}

function selectAgent(agentId) {
    closeAgentDialog();
    loadPrompt(agentId);
}

function loadPrompt(agentId) {
    fetch(`/api/prompts/${agentId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error loading prompt: ' + data.error);
                return;
            }

            currentAgentId = agentId;
            originalContent = data.content;

            document.getElementById('current-agent').textContent = `Agent: ${agentId}`;
            document.getElementById('selected-agent-text').textContent = `${agentId} (${data.content.length} chars)`;
            document.getElementById('prompt-editor').value = data.content;
            document.getElementById('editor-section').style.display = 'block';
            document.getElementById('no-selection').style.display = 'none';

            updateStats();
        })
        .catch(error => {
            alert('Error loading prompt: ' + error);
        });
}

function savePrompt() {
    if (!currentAgentId) {
        alert('No agent selected');
        return;
    }

    const content = document.getElementById('prompt-editor').value;

    fetch(`/api/prompts/${currentAgentId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            content: content
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error saving prompt: ' + data.error);
            return;
        }

        originalContent = content;

        // Show success toast
        const toast = new bootstrap.Toast(document.getElementById('save-toast'));
        toast.show();

        // Update the button text to show new character count
        document.getElementById('selected-agent-text').textContent = `${currentAgentId} (${content.length} chars)`;

        // Update the modal option as well
        const modalOption = document.querySelector(`[data-agent-id="${currentAgentId}"] div:last-child`);
        if (modalOption) {
            modalOption.textContent = `${content.length} characters`;
        }
    })
    .catch(error => {
        alert('Error saving prompt: ' + error);
    });
}

function reloadPrompt() {
    if (!currentAgentId) {
        return;
    }

    if (document.getElementById('prompt-editor').value !== originalContent) {
        if (!confirm('You have unsaved changes. Are you sure you want to reload?')) {
            return;
        }
    }

    loadPrompt(currentAgentId);
}

function updateStats() {
    const content = document.getElementById('prompt-editor').value;
    document.getElementById('char-count').textContent = content.length;
    document.getElementById('line-count').textContent = content.split('\n').length;
}

// Close modal when clicking outside of it
document.getElementById('agent-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeAgentDialog();
    }
});

// Add hover effects to agent options
document.addEventListener('DOMContentLoaded', function() {
    const agentOptions = document.querySelectorAll('.agent-option');
    agentOptions.forEach(option => {
        option.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#006600';
            this.style.borderColor = '#00ff00';
            this.style.boxShadow = '0 0 5px #00ff00';
        });

        option.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '#222';
            this.style.borderColor = '#444';
            this.style.boxShadow = 'none';
        });
    });
});

// Update stats on text change
document.getElementById('prompt-editor').addEventListener('input', updateStats);

// Warn about unsaved changes
window.addEventListener('beforeunload', function(e) {
    if (currentAgentId && document.getElementById('prompt-editor').value !== originalContent) {
        e.preventDefault();
        e.returnValue = '';
    }
});

// Handle escape key to close modal
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeAgentDialog();
    }
});
</script>
{% endblock %}
