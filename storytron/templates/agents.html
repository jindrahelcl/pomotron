{% extends "base.html" %}

{% block title %}Příběh - StoryTRON{% endblock %}

{% block content %}
<div class="card">
    <h2>📖 Příběh</h2>
    <p>Aktuální stav příběhu a správa agentů v systému PomoTRON.</p>
</div>

{% if agents and agents.agents %}
<div class="agent-grid">
    {% for agent in agents.agents %}
    <div class="agent-card {% if agent.id == agents.active_agent %}active{% endif %}">
        <h3>{{ agent.name }}</h3>
        <p><strong>ID:</strong> <code>{{ agent.id }}</code></p>
        <p><strong>Spokojen:</strong> {{ '😊 ANO' if agent.satisfied else '😔 NE' }}</p>
        <p><strong>Historie:</strong> <span id="history-count-{{ agent.id }}">...</span> zpráv</p>
        <p><strong>TTS:</strong> {{ agent.tts_engine }} ({{ agent.tts_voice }})</p>

        <!-- TTS Configuration -->
        <div class="tts-config" style="margin: 10px 0; padding: 10px; border: 1px solid #444; border-radius: 4px;">
            <strong>🔊 TTS nastavení:</strong>
            <select id="tts-engine-{{ agent.id }}" onchange="updateTTSVoices('{{ agent.id }}', this.value)" style="margin: 5px; background-color: #2a2a2a; color: #cccccc; border: 1px solid #555;">
                <option value="festival" {{ 'selected' if agent.tts_engine == 'festival' else '' }}>Festival</option>
                <option value="gtts" {{ 'selected' if agent.tts_engine == 'gtts' else '' }}>Google TTS</option>
                <option value="openai" {{ 'selected' if agent.tts_engine == 'openai' else '' }}>OpenAI TTS</option>
                <option value="gemini" {{ 'selected' if agent.tts_engine == 'gemini' else '' }}>Gemini TTS</option>
            </select>
            <select id="tts-voice-{{ agent.id }}" style="margin: 5px; background-color: #2a2a2a; color: #cccccc; border: 1px solid #555;">
                <!-- Voices populated by JavaScript -->
            </select>
            <button type="button" class="btn" style="font-size: 10px; padding: 4px 8px; margin-left: 5px;" onclick="saveTTSConfig('{{ agent.id }}')">
                💾 Uložit
            </button>
        </div>

        <div style="margin-top: 10px;">
            <form method="POST" action="{{ url_for('toggle_agent_satisfaction') }}" style="display: inline;">
                <input type="hidden" name="agent_id" value="{{ agent.id }}">
                <button type="submit" class="btn" style="font-size: 12px; padding: 8px 12px;">
                    {{ 'Nasrat' if agent.satisfied else 'Uspokojit' }}
                </button>
            </form>

            <button type="button" class="btn" style="background-color: #006600; border-color: #00ff00; color: #99ff99; font-size: 12px; padding: 8px 12px; margin-left: 5px;" onclick="resetAgentHistory('{{ agent.id }}', '{{ agent.name }}')">
                🗑️ Resetovat historii
            </button>
        </div>

        {% if agent.id == agents.active_agent %}
            <div style="margin-top: 15px;">
                <span style="color: #00ff00; font-weight: bold;">✅ AKTIVNÍ AGENT</span>
            </div>
        {% else %}
            <form method="POST" action="{{ url_for('web_switch_agent') }}" style="margin-top: 15px;">
                <input type="hidden" name="agent_id" value="{{ agent.id }}">
                <button type="submit" class="btn">🔄 Aktivovat</button>
            </form>
        {% endif %}
    </div>
    {% endfor %}
</div>

<div class="card">
    <h2>ℹ️ Informace o příběhu</h2>
    <p><strong>Aktuálně aktivní:</strong> {{ agents.active_agent }}</p>
    <p><strong>Celkem agentů:</strong> {{ agents.agents|length }}</p>
    <p><strong>Poslední aktualizace:</strong> {{ moment().format('HH:mm:ss') if moment else 'N/A' }}</p>

    <div style="margin-top: 20px; border-top: 1px solid #333; padding-top: 15px;">
        <form method="POST" action="{{ url_for('reset_story') }}" onsubmit="return confirm('Opravdu chcete resetovat celý příběh? Všichni agenti budou nespokojen a aktivní bude první agent.');" style="display: inline;">
            <button type="submit" class="btn" style="background-color: #660000; border-color: #ff0000; color: #ff9999;">
                🔄 Resetovat příběh
            </button>
        </form>

        <button type="button" class="btn" style="background-color: #cc6600; border-color: #ff9900; color: #ffcc99; margin-left: 10px;" onclick="resetAllHistory()">
            🗑️ Resetovat celou historii
        </button>
    </div>
</div>

{% else %}
<div class="card error">
    <h2>❌ Nepodařilo se načíst příběh</h2>
    <p>Nelze se připojit k StoryTRON API pro získání stavu příběhu.</p>
    <button class="btn" onclick="location.reload()">🔄 Zkusit znovu</button>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Load history counts for all agents when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadAllAgentHistoryCounts();
    loadTTSEnginesAndInitialize();
});

// TTS Configuration
let ttsEngines = {};

function loadTTSEnginesAndInitialize() {
    fetch('/api/tts/engines')
    .then(response => response.json())
    .then(data => {
        ttsEngines = data.engines;
        // Initialize TTS voice dropdowns for all agents
        const agentCards = document.querySelectorAll('.agent-card');
        agentCards.forEach(card => {
            const agentId = card.querySelector('h3').nextElementSibling.querySelector('code').textContent;
            const engineSelect = document.getElementById(`tts-engine-${agentId}`);
            if (engineSelect) {
                updateTTSVoices(agentId, engineSelect.value);
            }
        });
    })
    .catch(error => {
        console.error('Error loading TTS engines:', error);
    });
}

function updateTTSVoices(agentId, engine) {
    const voiceSelect = document.getElementById(`tts-voice-${agentId}`);
    if (!voiceSelect || !ttsEngines[engine]) return;

    // Clear existing options
    voiceSelect.innerHTML = '';

    // Add voice options for the selected engine
    ttsEngines[engine].forEach(voice => {
        const option = document.createElement('option');
        option.value = voice;
        option.textContent = voice;
        voiceSelect.appendChild(option);
    });

    // Load current agent TTS config to set the correct voice
    fetch(`/api/agents/${agentId}/tts`)
    .then(response => response.json())
    .then(data => {
        if (data.tts_engine === engine && data.tts_voice) {
            voiceSelect.value = data.tts_voice;
        }
    })
    .catch(error => {
        console.error(`Error loading TTS config for agent ${agentId}:`, error);
    });
}

function saveTTSConfig(agentId) {
    console.log('saveTTSConfig called with agentId:', agentId);
    const engineSelect = document.getElementById(`tts-engine-${agentId}`);
    const voiceSelect = document.getElementById(`tts-voice-${agentId}`);
    console.log('engineSelect:', engineSelect, 'voiceSelect:', voiceSelect);

    if (!engineSelect || !voiceSelect) {
        console.log('Missing elements, returning early');
        return;
    }

    const config = {
        tts_engine: engineSelect.value,
        tts_voice: voiceSelect.value
    };

    fetch(`/api/agents/${agentId}/tts`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        console.log('TTS save response:', data);
        if (data.message) {
            console.log('Calling showSuccessToast');
            showSuccessToast(`TTS konfigurace pro agenta "${agentId}" byla úspěšně uložena!`);
        } else {
            console.log('Calling showErrorToast');
            showErrorToast('Chyba při ukládání TTS konfigurace: ' + (data.error || 'Neznámá chyba'));
        }
    })
    .catch(error => {
        console.log('TTS save error:', error);
        showErrorToast('Chyba při ukládání TTS konfigurace: ' + error);
    });
}

function loadAllAgentHistoryCounts() {
    // Get all agent IDs from the page
    const agentCards = document.querySelectorAll('.agent-card');
    agentCards.forEach(card => {
        const agentId = card.querySelector('h3').nextElementSibling.querySelector('code').textContent;
        loadAgentHistoryCount(agentId);
    });
}

function loadAgentHistoryCount(agentId) {
    fetch(`/api/agents/${agentId}/history`)
    .then(response => response.json())
    .then(data => {
        if (data.history_count !== undefined) {
            const countElement = document.getElementById(`history-count-${agentId}`);
            if (countElement) {
                countElement.textContent = data.history_count;
            }
        }
    })
    .catch(error => {
        console.error(`Error loading history count for agent ${agentId}:`, error);
        const countElement = document.getElementById(`history-count-${agentId}`);
        if (countElement) {
            countElement.textContent = '?';
        }
    });
}

function resetAgentHistory(agentId, agentName) {
    if (confirm(`Opravdu chcete vymazat historii pro agenta "${agentName}"? Tato akce je nevratná.`)) {
        fetch(`/api/agents/${agentId}/history`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                showSuccessToast(`Historie pro agenta "${agentName}" byla úspěšně vymazána! (Smazáno: ${data.removed_count} zpráv)`);
                // Update the history count for this agent
                loadAgentHistoryCount(agentId);
            } else {
                showErrorToast('Chyba při mazání historie: ' + (data.error || 'Neznámá chyba'));
            }
        })
        .catch(error => {
            showErrorToast('Chyba při mazání historie: ' + error);
        });
    }
}

function resetAllHistory() {
    if (confirm('Opravdu chcete vymazat celou historii zpráv pro všechny agenty? Tato akce je nevratná.')) {
        fetch('/api/history', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                showSuccessToast('Celá historie byla úspěšně vymazána!');
                // Reload all agent history counts
                loadAllAgentHistoryCounts();
            } else {
                showErrorToast('Chyba při mazání historie: ' + (data.error || 'Neznámá chyba'));
            }
        })
        .catch(error => {
            showErrorToast('Chyba při mazání historie: ' + error);
        });
    }
}
</script>
{% endblock %}
